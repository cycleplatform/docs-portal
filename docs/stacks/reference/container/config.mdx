---
sidebar_label: Config
sidebar_position: 2
---

import CodeBlock from "@theme/CodeBlock";
import { DeployTable } from "../components/config/deploy/deploytable";
import { InstancesTable, MatchTable, StartsTable, StatefulExample } from "../components/config/deploy/stateful";
import { ConstraintsExample, ShutdownExample, TelemetryExample, HealthCheckExample, RestartExample, StartupExample } from "../components/config/deploy/deploy";
import { RuntimeTable, RuntimeExample, SeccompRulesTable, SeccompRulesCapabilitiesTable, SeccompRulesSyscallTable, SeccompArgsTable, SeccompObjectTable } from "../components/config/runtime/runtime";
import { IntegrationsExample } from "../components/config/integrations";
import { ResourcesExample } from "../components/config/resources";

# Container Config

The container configuration allows for ultra granular access to network, deployment, runtime, resource, and itegration settings.

`Config Top Level`

| Field        | Type   | Required | Description                                                                                               |
| ------------ | ------ | :------: | --------------------------------------------------------------------------------------------------------- |
| network      | Object |    ✅    | Network access, ports, and hostnames.                                                                     |
| deploy       | Object |    ✅    | Deployment configuration - notably instance counts, strategies, resources, and recovery configurations.   |
| runtime      | Object |    ❌    | Runtime configuration including permissions, overrides to commands, and other post build runtime changes. |
| resources    | Object |    ❌    | Specifically resources limits and values for the instances of the container.                              |
| integrations | Object |    ❌    | Container integrations, currently supporting advanced TLS settings.                                       |

## Network

| Field    | Type   | Required | Description                                                                                          |
| -------- | ------ | :------: | ---------------------------------------------------------------------------------------------------- |
| hostname | String |    ✅    | The container hostname used by Cycle's discovery service for DNS queries.                            |
| public   | String |    ✅    | the containers network setting for public internet - choices are `enable`, `disable`, `egress-only`. |
| ports    | String |    ❌    | an array of port mappings for the container.                                                         |

### Network Config Example

```json
{
  "hostname": "server",
  "public": "enable",
  "ports": ["80:80", "443:80"]
}
```

## Deploy

<DeployTable />

:::note Deployment Strategies
For a full breakdown of the different deployment strategies available click [here](https://docs.cycle.io/docs/containers/configuration/deployment)
.
:::

### Stateful

The stateful object holds a single key called `instances`.

`stateful:`

| Field     | Type  | Required | Description                                                                                               |
| --------- | ----- | :------: | --------------------------------------------------------------------------------------------------------- |
| instances | Array |    ✅    | An array of instance objects which allow for granular control over each instance of a stateful container. |

### Instances

An instances object is represented by the following values:

`instances:`

<InstancesTable />

#### Stateful Instance Match

The instance object describes the instance being targeted in the `match` object. Currently, for each instance of a stateful container created, Cycle will look at the hostname and prepend a number (starting at 1) separated by a dot.

To match a stateful containers first instance, the user can simply use the hostname value `1.thecontainershostname`.
`match:`

<MatchTable />

#### Statful Instance Start Commands

`default`, `first`, and `auto` _start_ each have different use cases, but the object shape is consistent between them.

`starts:`

<StartsTable />

<CodeBlock className="language-json">{StatefulExample}</CodeBlock>

### Constraints

Constraints are used to add rules about when the corresponding container can be created and to which servers it can be deployed.

`constraints:`

| Field      | Type   | Required | Description                                                                                                         |
| ---------- | ------ | :------: | ------------------------------------------------------------------------------------------------------------------- |
| node       | Object |    ❌    | An object holding information constraining the list of possible servers the container instances can be deployed to. |
| containers | Array  |    ❌    | An array of container identifiers that must exist before this container will be started.                            |

The containers array is a list of container identifiers that must exist before the given container will be sent the start signal. The container identifiers existence does not guarantee the existence of the other identified containers just that their identifiers exist.

### Node

`node:`

| Field | Type   | Required | Description                          |
| ----- | ------ | :------: | ------------------------------------ |
| tags  | Object |    ✅    | An object holding two lists of tags. |

#### Node Tags

There are 2 types of node tags: `any` & `all`.

`tags:`

| Field | Type  | Required | Description                                                                                                 |
| ----- | ----- | :------: | ----------------------------------------------------------------------------------------------------------- |
| any   | Array |    ❌    | The `any` list of tags is satisfied if `any` of the tags from the list are present on a given server..      |
| all   | Array |    ❌    | The `all` list of tags is satisfied only if `all` of the tags from the list are present on a given server.. |

<CodeBlock className="language-json">{ConstraintsExample}</CodeBlock>

### Shutdown

The shutdown policy is an optional configuration that gives the user control over how the initial shutdown of the instance should be handled.

| Field            | Type   | Required | Description                                                                                        |
| ---------------- | ------ | :------: | -------------------------------------------------------------------------------------------------- |
| graceful_timeout | Number |    ✅    | The time in seconds Cycle will wait before escalating the shutdown command from SIGINT to SIGKILL. |
| all              | Array  |    ✅    | A list of SIGNALS to use - Do not use `SIGKILL`.                                                   |

<CodeBlock className="language-json">{ShutdownExample}</CodeBlock>

### Startup

The startup policy is an optional configuration for actions to take during instance startup.

| Field | Type   | Required | Description                                                                                |
| ----- | ------ | :------: | ------------------------------------------------------------------------------------------ |
| delay | Number |    ❌    | A value in seconds that Cycle will wait before sending the start signal to this container. |

<CodeBlock className="language-json">{StartupExample}</CodeBlock>

### Restart

The restart policy is an optional configuration for actions to take if a container fails.

| Field        | Type   | Required | Description                                                                                                                                                              |
| ------------ | ------ | :------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| condition    | String |    ✅    | When a container qualifies for a restart event, this value will represent how often the restart policy is applied. The possible values are `always`, `never`, `failure`. |
| max_attempts | Number |    ✅    | The maximum amount of times the restart policy will be applied before manual intervention is required.                                                                   |
| delay        | Number |    ✅    | A value in seconds that Cycle will wait before sending the start signal to this container.                                                                               |

<CodeBlock className="language-json">{RestartExample}</CodeBlock>

### Health Checks

The health check policy is an optional configuration that can be used to check on the health of a running instance.

| Field    | Type    | Required | Description                                                                                                                                            |
| -------- | ------- | :------: | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| command  | String  |    ✅    | A command or path to an executable that should be run to perform the health check. The program or command should exit with code 0 if it is successful. |
| retries  | Number  |    ✅    | The number of times Cycle will retry the health check command.                                                                                         |
| interval | Number  |    ✅    | A value in seconds that Cycle will wait between retries.                                                                                               |
| timeout  | Number  |    ✅    | The maximum amount of time the command or program can run before timing out.                                                                           |
| restart  | Boolean |    ✅    | A boolean where true means the container instance should restart if its unhealthy.                                                                     |

<CodeBlock className="language-json">{HealthCheckExample}</CodeBlock>

### Telemetry

Telemetry is an optional configuration for reporting instance telemetry.

| Field     | Type    | Required | Description                                                                                  |
| --------- | ------- | :------: | -------------------------------------------------------------------------------------------- |
| retention | Number  |    ✅    | The number in seconds for telemetry data to be retained. This defaults to 21,600 or 6 hours. |
| webhook   | String  |    ❌    | An optional webhook to report the telemetry data to.                                         |
| interval  | Number  |    ✅    | A number in seconds to wait between samples. Default is 30 seconds.                          |
| disable   | Boolean |    ✅    | A boolean where true represents telemetry reporting as disabled.                             |

<CodeBlock className="language-json">{TelemetryExample}</CodeBlock>

## Runtime

Runtime settings are specifically settings that could affect the way the container behaviour during runtime.

<RuntimeTable />

<CodeBlock className={"language-json"}>{RuntimeExample}</CodeBlock>

### Seccomp

The seccomp object gives the user the power to disable seccomp or to define an array of seccomp rules to be used.

<SeccompObjectTable />

### Seccomp Rules

Seccomp rules provide the user with granular control over system calls allowed per container. The top level object holds two objects `capabilites` and `syscall`.

<SeccompRulesTable />

### Seccomp Capabilities

When setting the seccomp rules - this object stores an associated capability. Its reads as such - "If the capabilities includes/excludes the given capability, then follow this rule".

<SeccompRulesCapabilitiesTable />

### Seccomp Rules SysCall

The set of rules to follow given a capability is included/excluded.

<SeccompRulesSyscallTable />

#### Syscall Args

An optional set of args for the given syscall rule.

<SeccompArgsTable />

## Resources

The purpose of the resource config is to explicitly set resource limits and reserves for container instances.

:::note
The word `cores` is used interchangeably with the word thread in the following descriptions. For most virtual machines, a provider will assign vCPU resources in the sense that `1 vCPU = 1 execution thread`. There are however some servers which provide multi-threaded cores - where a core represents `>1` thread. In those cases please refer to the following documentation section with that in mind.
:::

| Field | Type   | Required | Description                                                          |
| ----- | ------ | :------: | -------------------------------------------------------------------- |
| cpu   | Object |    ✅    | An object holding the CPU shares limit and reserve settings.         |
| ram   | Object |    ✅    | An object holding the RAM container instance configuration settings. |

<CodeBlock className="language-json">{ResourcesExample}</CodeBlock>

### CPU Shares & Core Pinning

Trying to understand the complexities of CPU resource allocation can be an uphill battle for developers not versed in systems engineering. On Cycle, container instances have access to `shares`. A single share represent 10% of the available resources for one CPU and 10 shares represents 100% of a given CPU's resources.

Each instance of a container will be deployed to a server, if a user wishes to explicitly set which cores each instance will have access to on its host machine, the cpus string can be used.

For a single core a user may submit the string `"0"` - showing their intent to pin to the first core on the host machine. To define more than a single core, but maintain specificity the format `"0,2"` can be used. Finally, to show that a range of CPU cores can be used the format `"0-4"` can be used - which would represnt pinning the process to the first 4 cores

| Field  | Type   | Required | Description                                                  |
| ------ | ------ | :------: | ------------------------------------------------------------ |
| shares | Object |    ❌    | An object holding the CPU shares limit and reserve settings. |
| cpus   | String |    ❌    | A string of CPU cores (threads) to pin this instance to.     |

#### Limits And Reserves

| Field   | Type   | Required | Description                                                     |
| ------- | ------ | :------: | --------------------------------------------------------------- |
| limit   | Number |    ❌    | The maximum amount of shares each instance has access to.       |
| reserve | Number |    ❌    | The shares to be allocated for each instance of this container. |

### RAM

Instead of numbers, RAM fields are delineated with strings where the first part of the string is a number followed by the byte assignment.

<details>
<summary>Byte Assignment Values Table</summary>

| Value | Represents |
| ----- | ---------- |
| K     | Kilobyte   |
| M     | Megabyte   |
| G     | Gigabyte   |

</details>
<br />

| Field     | Type   | Required | Description                                                  |
| --------- | ------ | :------: | ------------------------------------------------------------ |
| limit     | String |    ❌    | The maximum amount of RAM each instance will have access to. |
| reserve   | String |    ❌    | The amount of RAM to reserve for each instance.              |
| swapiness | Number |    ❌    | The swapiness value for each instance `0-100`.               |

## Integrations

Integrations is an optional section of configurations that allows the user to take control over files, certificates and webhook's for the container.

| Field        | Type   | Required | Description                                                |
| ------------ | ------ | :------: | ---------------------------------------------------------- |
| lets_encrypt | Object |    ❌    | Advanced certificate integration for the container.        |
| webhooks     | Object |    ❌    | Webhooks for container events.                             |
| files        | Array  |    ❌    | Files from the repository to be copied into the container. |

<CodeBlock className="language-json">{IntegrationsExample}</CodeBlock>

### TLS Integrations

For containers that absolutely must have certificates installed onboard, users may add the optional `lets_encrypt` TLS certificate configuration, which associates a TLS certificate for a user owned domain.

| Field            | Type    | Required | Description                                                                                                              |
| ---------------- | ------- | :------: | ------------------------------------------------------------------------------------------------------------------------ |
| enable           | Boolean |    ✅    | Enable the TLS cert integration. For any path omitted by a user - the default path will be used.                         |
| certificate_path | String  |    ❌    | `/var/run/cycle/tls/current.cert` The path where the TLS certificate for the associated record can be found.             |
| key_path         | String  |    ❌    | `/var/run/cycle/tls/current.key` The path where the private key for the associated TLS certificate can be found.         |
| chain_path       | String  |    ❌    | `/var/run/cycle/tls/current.chain` The path where the certificate chain for the associated TLS certificate can be found. |
| bundle_path      | String  |    ❌    | `/var/run/cycle/tls/current.bundle` The path where the certificate bundle can be found.                                  |

### Webhooks

An optional configuration holding endpoints that will be reported to when the associated event occurs.

`webhooks`

| Field  | Type   | Required | Description                                                          |
| ------ | ------ | :------: | -------------------------------------------------------------------- |
| events | Object |    ❌    | Endpoints that will be reported to when the associated event occurs. |

`events`

| Field  | Type   | Required | Description                                                              |
| ------ | ------ | :------: | ------------------------------------------------------------------------ |
| deploy | String |    ❌    | A webhook that should be posted to after container deploy events happen. |
| start  | String |    ❌    | A webhook that should be posted to after container start events happen.  |
| stop   | String |    ❌    | A webhook that should be posted to after container stop events happen.   |

### Files

If there are files in the repo that need to be copied to the container but are not included in the image, this object can be used to define where to find those files and where to install them.

| Field       | Type   | Required | Description                                                      |
| ----------- | ------ | :------: | ---------------------------------------------------------------- |
| source      | String |    ❌    | The path to the file in the repository that should be copied.    |
| destination | String |    ❌    | The path to where in the container the file should be copied to. |
