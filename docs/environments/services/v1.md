---
sidebar_label: Native LB
sidebar_position: 4
---

# Native Load Balancer

Cycle's native load balancer modal comes with a growing number of sections including the soon to be released monitoring page. Given this additional number of pages and its ability to hold complex configurations we've dedicated an entire page here.

## Config

:::info Not Finding What You Want?
This section is meant to cover the portal level implementation for configuring the v1 load balancer. If theres a field or value that isn't quite explained thoroughly enough here, you may want to take a look at the [stack reference](/docs/stacks/reference/services/v1) which has a bit more structured information.
:::

The config page is where users can make configuration to the default settings on the v1 load balancer. This page can be broken down into several sections:

- Port
- General
- Routers
- TLS

## Port

Each port represents a controller, you can think of this as a designated space to handle the configuration mechanics for all traffic that comes in on that specific port. By default you'll notice there are 4 port controllers set up:

- 80
- 443
- 8812
- 1194

To create a new port controller, simply add the port number into the box and press the `Add` button. This will create a new entry on the list with a new configuration set for that port that can be customized to the needs of the service.

## General

The general section has port specific general settings.

- **Identifier** - The identifier, like identifiers on other cycle resources, is a way for the user to give a resource a name. This setting will mainly be helpful when using the API and CLI when interacting with the load balancer port settings after creation.
- **Ingress Port** - The literal ingress port that this configuration pertains to.
- **Mode** - Either `TCP` or `HTTP`. Generally users will select http for http protocol load balancing and TCP for non-http as TCP is protocol agnostic.
- **Logging Verbosity** - This setting is directly related to the verbosity of the logs printed to the instance console. The higher the setting the more detail is recorded.
- **Idle Timeout** - The amount of time a connection can be idle before its dropped.
- **Performance** - A toggle for performance mode. In this mode telemetry is disabled so that all available resources can be put towards load balancer functionality.

## Routers

Routers are used to set specific functionality on internal ports, paths, or urls. These will execute in order they are defined if specificity is the same. Users can add a router by using the `Add Router` button and then adding to the configuration with more specific settings. To move routers up and down in priority use the `^` and `v` arrows, then save.

Each router has its own general settings, configuration, and extension settings.

### General

- **Mode** - The type of load balancing `round-robin` or `random`.
- **Match Domains** - An array of domains to match for.
- **Match Internal Ports** - An array of internal ports to match for.
- **Match Path** - A path to match for.

So for the given router, the user is setting the type of routing to be done here as well as creating some constraints around what inbound traffic qualifies to be routed by this router.

### Config

- **Destination Retries** - How many times the load balancer will retry reaching the intended target for the traffic.
- **Destination Connection Timeout** - The timeout associated with the attempt to make the connection.

### Extension

A router can have many extensions. Extensions are used to define specific behavior and are configured in the portal through a JSON blob.

| Field      | Type   | Required | Description                                                 |
| ---------- | ------ | :------: | ----------------------------------------------------------- |
| `redirect` | Object |    ❌    | Defines a built-in redirect for HTTP mode routers.          |
| `forward`  | Object |    ❌    | Defines a built-in forwarding scheme for HTTP mode routers. |
| `proxy`    | Object |    ❌    | Defines proxy settings for the given router.                |
| `cache`    | Object |    ❌    | Defines cache settings for the given router.                |

#### Redirect

The redirect option allows a user to set incoming matches to redirect.

```json
{
  "redirect": {
    "auto_https_redirect": true,
    "remove_www": true,
    "port": 34567,
    "scheme": "https",
    "url": "otherurl.com"
  }
}
```

If you submit a redirect config, `Port`, `Scheme`, and `url` are optional settings, but `auto_https_redirect` and `remove_www` need a boolean submitted.

| Field                 | Type    | Required | Description                                                                                                                                                    |
| --------------------- | ------- | :------: | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `auto_https_redirect` | Boolean |    ✅    | If enabled and a sibling controller exists for port 443, requests will be auto redirected to it. Essentially sets up automatic TLS redirection for this router |
| `remove_www`          | Boolean |    ✅    | If true, any matching inbound request with `www` attached will have `www` removed.                                                                             |
| `port`                | Number  |    ❌    | The port to redirect traffic to.                                                                                                                               |
| `scheme`              | String  |    ❌    | The scheme to redirect traffic to.                                                                                                                             |
| `url`                 | String  |    ❌    | A specific URL to redirect traffic to.                                                                                                                         |

#### Forward

The forward option allows users to set a specific scheme to forward traffic to.

```json
{
  "forward": {
    "scheme": "https"
  }
}
```

#### Proxy

The proxy setting allows for the router to act as a proxy to a specified domain.

```json
{
  "proxy": {
    "domain": "anotherdomain.com"
  }
}
```

#### Cache

The cache configuration exposes a way for users to set caching of files up at the load balancer(s).

```json
{
  "caching": {
    "files": [
      {
        "match": "(.*)\\.(js|css|png|svg)",
        "ttl": "5m"
      }
    ]
  }
}
```

`files array`

| Field   | Type   | Required | Description                                                                                                                                                                                                  |
| ------- | ------ | :------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `match` | String |    ✅    | A regex pattern used to match files.                                                                                                                                                                         |
| `ttl`   | String |    ✅    | A value in a time string, ttl (time to live) is how long the files will be cached before another lookup. This accepts a string with modifiers. Example for 3 days 15 hours 10 minutes 5 seconds `3d15h10m5s` |

:::caution TCP Extension
Right now Cycle only shows support for the HTTP extension, however, if you look at the stack file reference you will see that there are plans to support TCP extensions as well. For now, all extensions created are HTTP extensions so you will not see that as an option to be configured.
:::

:::success Coming Soon Metrics
You might have noticed that there is now a metrics tab on the load balancer modal. As we finalize this portion of portal, we will also be updating this page of documentation to cover the output and options available.

Check back soon!
:::
